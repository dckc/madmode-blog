<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} - MadMode</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/minisearch@6.1.0/dist/umd/index.min.js"></script>
</head>
<body>
    <header>
        <h1><a href="/">MadMode</a></h1>
        <p>Dan Connolly's tinkering lab notebook</p>
        <nav>
            <ul>
                <li><a href="/archives/">Archives</a></li>
                <li><a href="/search/label/">Tags</a></li>
            </ul>
            <div class="search-form">
                <input type="text" id="search-input" placeholder="Search..." aria-label="Search">
                <button type="button" id="search-button">Search</button>
            </div>
        </nav>
    </header>
    <div id="search-results"></div>
    <main>
        {{ content | safe }}
        {% if page.url != "/" %}
        <hr>
        <p>Posted on: {{ page.date | date("%Y-%m-%d") }}</p>
        {% if tags %}
        <p>Tags: 
            {% for tag in tags %}
                {% if tag != "posts" %}
                    <a href="/search/label/{{ tag }}/" class="tag">{{ tag }}</a>{% if not loop.last %}, {% endif %}
                {% endif %}
            {% endfor %}
        </p>
        {% endif %}
        {% endif %}
    </main>
    <footer>
        <p>&copy; {{ "now" | date("%Y") }} Dan Connolly</p>
    </footer>
    <script>
        let miniSearch;
        let documents;

        fetch('/search-index.json')
            .then(response => response.json())
            .then(data => {
                documents = data;
                miniSearch = new MiniSearch({
                    fields: ['title', 'content'],
                    storeFields: ['title', 'url']
                });
                miniSearch.addAll(documents);
            });

        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        const searchResults = document.getElementById('search-results');

        function performSearch() {
            const query = searchInput.value;
            if (query.length < 3) {
                searchResults.innerHTML = '';
                return;
            }
            const results = miniSearch.search(query, { fuzzy: 0.2 });
            searchResults.innerHTML = results.map(result => 
                `<div>
                    <a href="${result.url || '#'}">${result.title || 'Untitled'}</a>
                    <p>${result.content ? result.content.substring(0, 150) + '...' : 'No content available'}</p>
                </div>`
            ).join('');
        }

        searchInput.addEventListener('input', performSearch);
        searchButton.addEventListener('click', performSearch);
    </script>
</body>
</html>
